# Deployment Guide

This document covers building, testing, and deploying the Trading Journal app.

## Table of Contents
- [Prerequisites](#prerequisites)
- [Environment Setup](#environment-setup)
- [Building for Platforms](#building-for-platforms)
- [Testing](#testing)
- [Mobile Testing](#mobile-testing)
- [Database Migrations](#database-migrations)
- [Release Checklist](#release-checklist)
- [Recent Changes](#recent-changes)

---

## Prerequisites

1. **Flutter SDK**: 3.10.0 or later
   ```bash
   flutter --version
   ```

2. **Firebase Project**: Configured with Authentication enabled
   - Google Sign-In
   - Email/Password Sign-In

3. **API Keys**:
   - Finnhub API key (optional, falls back to mock data without it)

---

## Environment Setup

### 1. Create Environment File

Create a `.env` file in the project root (this file is gitignored):

```env
FINNHUB_API_KEY=your_finnhub_api_key_here
```

### 2. Firebase Configuration

Firebase configuration is stored in `lib/firebase_options.dart`. This file is auto-generated by FlutterFire CLI.

**Required Firebase files:**
- `android/app/google-services.json` - Download from Firebase Console > Project Settings > Android app
- `ios/Runner/GoogleService-Info.plist` - Download from Firebase Console > Project Settings > iOS app

To set up Firebase for a new project:
```bash
# Install FlutterFire CLI
dart pub global activate flutterfire_cli

# Configure Firebase (creates all platform files)
flutterfire configure
```

This will:
1. Create/update `lib/firebase_options.dart`
2. Download `google-services.json` for Android
3. Download `GoogleService-Info.plist` for iOS

---

## Building for Platforms

### Web (Chrome)

**Development:**
```bash
flutter run -d chrome
```

**Release Build:**
```bash
# Standard build (smaller, uses HTML renderer for simpler graphics)
flutter build web --release

# CanvasKit build (larger, but better graphics fidelity - recommended for charts)
flutter build web --release --web-renderer canvaskit
```

Output is in `build/web/`. Deploy to any static hosting.

#### Option 1: Firebase Hosting (Recommended)

1. **Install Firebase CLI:**
   ```bash
   npm install -g firebase-tools
   firebase login
   ```

2. **Initialize (one-time):**
   ```bash
   firebase init hosting
   # Select your Firebase project
   # Public directory: build/web
   # Single-page app: Yes
   # Don't overwrite index.html
   ```

3. **Deploy:**
   ```bash
   flutter build web --release --web-renderer canvaskit
   firebase deploy --only hosting
   ```

#### Option 2: Cloudflare Pages

1. Connect your GitHub repo to Cloudflare Pages
2. Build command: `flutter build web --release --web-renderer canvaskit`
3. Output directory: `build/web`
4. Environment variable: `FLUTTER_ROOT` = `/opt/buildhome/.flutter`

#### Option 3: Vercel

Create `vercel.json`:
```json
{
  "buildCommand": "flutter/bin/flutter build web --release",
  "outputDirectory": "build/web",
  "installCommand": "git clone https://github.com/flutter/flutter.git -b stable"
}
```

#### Option 4: Static Hosting (Netlify, GitHub Pages, S3)

Simply upload the contents of `build/web/` to any static file host.

For GitHub Pages with a subdirectory:
```bash
flutter build web --release --base-href /repo-name/
```

### Windows Desktop

**Development:**
```bash
flutter run -d windows
```

**Release Build:**
```bash
flutter build windows --release
```

Output is in `build/windows/x64/runner/Release/`.

#### Windows Packaging (MSIX for Microsoft Store)

1. **Add msix package to pubspec.yaml:**
   ```yaml
   dev_dependencies:
     msix: ^3.16.0
   
   msix_config:
     display_name: Trading Journal
     publisher_display_name: Trading Journal
     identity_name: com.tradingjournal.app
     msix_version: 1.0.0.0
     logo_path: windows/runner/resources/app_icon.ico
   ```

2. **Build MSIX:**
   ```bash
   dart run msix:create
   ```

3. Output: `build/windows/x64/runner/Release/TradingJournal.msix`

#### Windows Portable Distribution

For distribution outside the Store, zip the Release folder:
```powershell
Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "TradingJournal-Windows.zip"
```

### macOS Desktop

**Development:**
```bash
flutter run -d macos
```

**Release Build:**
```bash
flutter build macos --release
```

Output is in `build/macos/Build/Products/Release/`.

#### macOS Distribution

**For Mac App Store:**
1. Archive in Xcode
2. Submit via App Store Connect

**For direct distribution (DMG):**
1. Code sign the app
2. Notarize with Apple
3. Create DMG with `create-dmg` or similar tool

### Linux Desktop

**Development:**
```bash
flutter run -d linux
```

**Release Build:**
```bash
flutter build linux --release
```

Output is in `build/linux/x64/release/bundle/`.

#### Linux Packaging

**AppImage (portable):**
Use `appimage-builder` or similar tool.

**Snap:**
```bash
snapcraft init
snapcraft
```

**Flatpak:**
Create a flatpak manifest and build with `flatpak-builder`.

### Android

**Development:**
```bash
flutter run -d android
```

**Release APK:**
```bash
flutter build apk --release
```

**App Bundle (for Play Store):**
```bash
flutter build appbundle --release
```

#### Android Signing Setup (Required for Release)

1. **Generate Upload Key** (one-time):
   ```bash
   keytool -genkey -v -keystore upload-keystore.jks -keyalg RSA -keysize 2048 -validity 10000 -alias upload
   ```

2. **Create `android/key.properties`** (gitignored):
   ```properties
   storePassword=your_store_password
   keyPassword=your_key_password
   keyAlias=upload
   storeFile=../upload-keystore.jks
   ```

3. **Update `android/app/build.gradle.kts`** to use the key:
   ```kotlin
   def keystoreProperties = new Properties()
   def keystorePropertiesFile = rootProject.file('key.properties')
   if (keystorePropertiesFile.exists()) {
       keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
   }

   android {
       signingConfigs {
           release {
               keyAlias keystoreProperties['keyAlias']
               keyPassword keystoreProperties['keyPassword']
               storeFile file(keystoreProperties['storeFile'])
               storePassword keystoreProperties['storePassword']
           }
       }
       buildTypes {
           release {
               signingConfig signingConfigs.release
           }
       }
   }
   ```

4. **Build signed AAB:**
   ```bash
   flutter build appbundle --release
   ```
   Output: `build/app/outputs/bundle/release/app-release.aab`

#### Play Store Submission
1. Create app in [Google Play Console](https://play.google.com/console)
2. Upload AAB to internal/closed testing track first
3. Fill out store listing, content rating, pricing
4. Submit for review

### iOS

**Development:**
```bash
flutter run -d ios
```

**Release Build:**
```bash
flutter build ios --release
```

---

## Testing

### Run All Tests
```bash
flutter test
```

### Run with Coverage
```bash
flutter test --coverage
```

### Specific Test Files
```bash
flutter test test/services/analytics_service_test.dart
```

### Key Test Cases

1. **Close Trade Removes Position Tool**
   - Create position tool on chart
   - Activate it to create a position
   - Close the position
   - Verify tool is removed from chart

2. **Persistence Across Restart**
   - Create a trade
   - Hot restart (R key in flutter run)
   - Verify trade still appears in journal
   - Full app close/reopen
   - Verify data persists

3. **Multi-User Data Isolation**
   - Sign in as User A
   - Create trades/positions
   - Sign out
   - Sign in as User B
   - Verify User A's data is not visible

---

## Mobile Testing

The app now has a responsive UI that adapts to mobile screen sizes. For comprehensive mobile testing, refer to `MOBILE_QA.md`.

### Quick Mobile Verification

```bash
# Web with Chrome mobile emulator
flutter run -d chrome --web-renderer html

# Android device
flutter run -d <device_id>

# List available devices
flutter devices
```

### Key Mobile Test Areas

1. **Google Sign-Up Auto-Login** - New users signing up via Google should immediately land in the app authenticated
2. **Chart UI Controls** - Drawing tools, timeframes, and stats should be accessible on small screens
3. **Position Tool Settings** - Tapping Long/Short shows a settings sheet for RR presets
4. **SL/TP Sync** - Position tool parameters sync bi-directionally with the trading panel

### Mobile Breakpoints

The app uses these responsive breakpoints:
- **Mobile:** < 600dp width
- **Tablet:** 600dp - 900dp width  
- **Desktop:** > 900dp width

---

## Database Migrations

The app uses Hive for local storage. Data is stored in these boxes:

| Box Name | Type | Description |
|----------|------|-------------|
| `trades` | Trade | Journal entries |
| `paper_account` | PaperAccount | Paper trading balance |
| `paper_positions` | PaperPosition | Open/closed positions |
| `paper_orders` | PaperOrder | Order history |
| `chart_drawings` | String (JSON) | Position tools |
| `candle_history_v2` | Candle | Chart data cache |

### Breaking Changes

If you modify Hive models (add/remove `@HiveField`), you must:

1. Regenerate adapters:
   ```bash
   dart run build_runner build --delete-conflicting-outputs
   ```

2. Consider data migration if existing data needs to be preserved.

### Clearing Local Data

For development, clear all local data:
- **Web**: Clear IndexedDB in browser DevTools
- **Desktop**: Delete Hive files in app data directory

---

## Release Checklist

### Pre-Release

- [ ] All tests pass: `flutter test`
- [ ] No analyzer warnings: `flutter analyze`
- [ ] Verify persistence in release build
- [ ] Test on all target platforms
- [ ] Check Firebase Authentication works
- [ ] Verify mock data fallback works (without API key)

### Build Commands

```bash
# Clean build cache
flutter clean

# Get dependencies
flutter pub get

# Regenerate generated files
dart run build_runner build --delete-conflicting-outputs

# Run analyzer
flutter analyze

# Build release
flutter build web --release
```

### Post-Deployment

- [ ] Verify app loads correctly
- [ ] Test sign-in flow
- [ ] Create a test trade
- [ ] Close trade and verify journal entry
- [ ] Hard refresh and verify persistence

---

## Troubleshooting

### Hot Restart Doesn't Persist Data
- Ensure `init()` is called on providers at app startup
- Check that `_saveState()` is being called after mutations

### Position Tool Stays After Close
- Verify `linkedToolId` is set when activating position
- Check `onPositionClosed` callback is wired up

### Firebase Auth Not Working
- Check `firebase_options.dart` is properly configured
- Verify Firebase project has web app registered
- Check allowed domains in Firebase Console

### Build Fails on Web
```bash
flutter clean
flutter pub get
flutter build web
```

### Hive Box Not Opening
- May need to clear corrupt data
- Check for mismatched type adapters after model changes

---

## Recent Changes

### December 2024 Update

#### Phase 1: Auth Auto-Login Fix (Google + Email)
- **Issue:** New users signing up (Google or Email) were not automatically signed in
- **Fix:** 
  - Modified `auth_service.dart` and `auth_provider.dart` to ensure immediate authentication state after successful OAuth/signup
  - Modified `signup_screen.dart` to navigate to main app after successful account creation
- **Files:** `lib/services/auth_service.dart`, `lib/state/auth_provider.dart`, `lib/screens/auth/signup_screen.dart`

#### Phase 2: Mobile UI Overhaul
- **Issue:** Chart UI controls overflowed and were unusable on mobile screens
- **Fix:** Added responsive layout with mobile-specific components
- **Changes:**
  - `_MobileDrawingToolsMenu` - Popup menu for drawing tools on mobile
  - Horizontally scrollable OHLC stats and timeframe buttons
  - Compact trading panel layout for mobile
- **Files:** `lib/screens/chart_screen.dart`

#### Phase 3a: Position Tool RR Presets
- **Feature:** Users can now set Risk:Reward parameters before placing a position tool
- **Changes:**
  - `_PositionToolSettingsSheet` - Bottom sheet for configuring SL%, R:R ratio, and quantity
  - Settings are applied when the position tool is placed on the chart
- **Files:** `lib/screens/chart_screen.dart`, `lib/state/chart_drawing_provider.dart`

#### Phase 3b: SL/TP Bi-directional Sync
- **Feature:** Position tool SL/TP values sync with the trading panel
- **Changes:**
  - Selecting a position tool populates SL% and TP% in the Order panel
  - Editing SL/TP in the Order panel updates the position tool on the chart
  - Prevents circular update loops
- **Files:** `lib/screens/chart_screen.dart`

#### New Documentation
- **MOBILE_QA.md** - Comprehensive mobile testing checklist

---

## Documentation Index

| Document | Purpose |
|----------|---------|
| `README.md` | Project overview and setup |
| `DEPLOYMENT.md` | Build and deployment instructions (this file) |
| `RELEASE_REPORT.md` | Release readiness audit |
| `ENV.md` | Environment variables |
| `MOBILE_QA.md` | Mobile testing checklist |
| `FINAL_PROJECT_REPORT.md` | Architecture and design documentation |

---

## Current Deployment Status

### Web (Firebase Hosting)
- **URL:** https://trading-app-68902.web.app
- **Last Deployed:** December 17, 2024
- **Version:** 1.0.1+2 (with mobile UI fixes)

### Android APK
- **Location:** `build/app/outputs/flutter-apk/app-release.apk`
- **Size:** ~56 MB
- **Last Built:** December 17, 2024

### Deployment Commands Used
```powershell
# Clean and rebuild
flutter clean
flutter pub get

# Build and deploy web
flutter build web --release
firebase deploy --only hosting

# Build Android APK
flutter build apk --release
```

