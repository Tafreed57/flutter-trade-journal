# Deployment Guide

This document covers building, testing, and deploying the Trading Journal app.

## Table of Contents
- [Prerequisites](#prerequisites)
- [Environment Setup](#environment-setup)
- [Building for Platforms](#building-for-platforms)
- [Testing](#testing)
- [Database Migrations](#database-migrations)
- [Release Checklist](#release-checklist)

---

## Prerequisites

1. **Flutter SDK**: 3.10.0 or later
   ```bash
   flutter --version
   ```

2. **Firebase Project**: Configured with Authentication enabled
   - Google Sign-In
   - Email/Password Sign-In

3. **API Keys**:
   - Finnhub API key (optional, falls back to mock data without it)

---

## Environment Setup

### 1. Create Environment File

Create a `.env` file in the project root (this file is gitignored):

```env
FINNHUB_API_KEY=your_finnhub_api_key_here
```

### 2. Firebase Configuration

Firebase configuration is stored in `lib/firebase_options.dart`. This file is auto-generated by FlutterFire CLI.

To regenerate for a new Firebase project:
```bash
flutterfire configure
```

---

## Building for Platforms

### Web (Chrome)

**Development:**
```bash
flutter run -d chrome
```

**Release Build:**
```bash
flutter build web --release
```

Output is in `build/web/`. Deploy to any static hosting (Firebase Hosting, Vercel, Netlify, etc.).

**Firebase Hosting Deployment:**
```bash
firebase deploy --only hosting
```

### Windows Desktop

**Development:**
```bash
flutter run -d windows
```

**Release Build:**
```bash
flutter build windows --release
```

Output is in `build/windows/x64/runner/Release/`.

### macOS Desktop

**Development:**
```bash
flutter run -d macos
```

**Release Build:**
```bash
flutter build macos --release
```

### Android

**Development:**
```bash
flutter run -d android
```

**Release APK:**
```bash
flutter build apk --release
```

**App Bundle (for Play Store):**
```bash
flutter build appbundle --release
```

### iOS

**Development:**
```bash
flutter run -d ios
```

**Release Build:**
```bash
flutter build ios --release
```

---

## Testing

### Run All Tests
```bash
flutter test
```

### Run with Coverage
```bash
flutter test --coverage
```

### Specific Test Files
```bash
flutter test test/services/analytics_service_test.dart
```

### Key Test Cases

1. **Close Trade Removes Position Tool**
   - Create position tool on chart
   - Activate it to create a position
   - Close the position
   - Verify tool is removed from chart

2. **Persistence Across Restart**
   - Create a trade
   - Hot restart (R key in flutter run)
   - Verify trade still appears in journal
   - Full app close/reopen
   - Verify data persists

3. **Multi-User Data Isolation**
   - Sign in as User A
   - Create trades/positions
   - Sign out
   - Sign in as User B
   - Verify User A's data is not visible

---

## Database Migrations

The app uses Hive for local storage. Data is stored in these boxes:

| Box Name | Type | Description |
|----------|------|-------------|
| `trades` | Trade | Journal entries |
| `paper_account` | PaperAccount | Paper trading balance |
| `paper_positions` | PaperPosition | Open/closed positions |
| `paper_orders` | PaperOrder | Order history |
| `chart_drawings` | String (JSON) | Position tools |
| `candle_history_v2` | Candle | Chart data cache |

### Breaking Changes

If you modify Hive models (add/remove `@HiveField`), you must:

1. Regenerate adapters:
   ```bash
   dart run build_runner build --delete-conflicting-outputs
   ```

2. Consider data migration if existing data needs to be preserved.

### Clearing Local Data

For development, clear all local data:
- **Web**: Clear IndexedDB in browser DevTools
- **Desktop**: Delete Hive files in app data directory

---

## Release Checklist

### Pre-Release

- [ ] All tests pass: `flutter test`
- [ ] No analyzer warnings: `flutter analyze`
- [ ] Verify persistence in release build
- [ ] Test on all target platforms
- [ ] Check Firebase Authentication works
- [ ] Verify mock data fallback works (without API key)

### Build Commands

```bash
# Clean build cache
flutter clean

# Get dependencies
flutter pub get

# Regenerate generated files
dart run build_runner build --delete-conflicting-outputs

# Run analyzer
flutter analyze

# Build release
flutter build web --release
```

### Post-Deployment

- [ ] Verify app loads correctly
- [ ] Test sign-in flow
- [ ] Create a test trade
- [ ] Close trade and verify journal entry
- [ ] Hard refresh and verify persistence

---

## Troubleshooting

### Hot Restart Doesn't Persist Data
- Ensure `init()` is called on providers at app startup
- Check that `_saveState()` is being called after mutations

### Position Tool Stays After Close
- Verify `linkedToolId` is set when activating position
- Check `onPositionClosed` callback is wired up

### Firebase Auth Not Working
- Check `firebase_options.dart` is properly configured
- Verify Firebase project has web app registered
- Check allowed domains in Firebase Console

### Build Fails on Web
```bash
flutter clean
flutter pub get
flutter build web
```

### Hive Box Not Opening
- May need to clear corrupt data
- Check for mismatched type adapters after model changes

